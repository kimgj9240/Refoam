<html layout:decorate="~{layout}" lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container mb-5" layout:fragment="content">
    <h2 class="py-4">공정 건수</h2>


    <h2 class="py-4">에러 건수</h2>
    <h2 class="py-4">재고 건수</h2>
    <canvas id="materialChart" height="100"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
        const materialLabels = /*[[${materialLabels}]]*/ [];
        const materialData = /*[[${materialData}]]*/ [];
        const materialColors = /*[[${materialColors}]]*/ [];


        const ctx2 = document.getElementById('materialChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: materialLabels,
                datasets: [{
                    label: '원재료별 수량',
                    data: materialData,
                    backgroundColor: materialColors,
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {beginAtZero: true},
                    x: {title: {display: true, text: '원재료'}}
                }
            }
        });
    </script>

    <div >
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
        <!-- date-fns 어댑터 (Chart.js v3+) -->
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
        <!-- 서버 제공 클라이언트 -->
        <script src="/socket.io/socket.io.js"></script>
        <style>
            canvas { background: #fafafa; border: 1px solid #ddd; }
        </style>
        <h2>금형 온도 실시간 모니터링</h2>
        <canvas id="tempChart" width="800" height="400"></canvas>

        <script>
            // 1) 소켓 연결 확인용 로그
            const socket = io('http://localhost:5000', {
                transports: ['websocket','polling']
            });
            socket.on('connect', () => console.log('Socket.IO connected'));

            // 2) 차트 초기화
            const ctx = document.getElementById('tempChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'Temperature (℃)', data: [], borderWidth: 2, fill: false }] },
                options: {
                    parsing: false,        // {x,y} 구조 사용
                    animation: false,      // 부드러운 애니메이션 비활성
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'second', tooltipFormat: 'HH:mm:ss' },
                            title: { display: true, text: 'Time' }
                        },
                        y: {
                            title: { display: true, text: 'Temperature (℃)' },
                            suggestedMin: 40,
                            suggestedMax: 70
                        }
                    }
                }
            });

            // 3) 서버에서 푸시된 데이터 받기
            socket.on('new_data', msg => {
                console.log('Received:', msg);
                chart.data.datasets[0].data.push({ x: msg.time, y: msg.value });
                if (chart.data.datasets[0].data.length > 50) chart.data.datasets[0].data.shift();
                chart.update('none');
            });
        </script>
    </div>



</div>
</html>