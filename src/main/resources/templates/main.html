<html layout:decorate="~{layout}" lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container mb-5" layout:fragment="content">
    <h2 class="my-4">오늘의 달성률</h2>
    <div class="row mb-5">
        <div class="col-12 col-md-6 col-lg-6">
            <h5 class="text-center mt-3">
                오늘의 목표 수량: <span th:text="${targetQuantity}">0</span>개
            </h5>
            <div class="tassei">
                <canvas id="achievementRate"></canvas>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-6 my-sm-3 my-md-5 my-lg-4 ">
            <div class="row">
                <div class="card shadow-sm mb-2 col">
                    <div class="card-body">
                        <h6 class="text-muted">✅ 달성 수량</h6>
                        <h4 th:text="${okCount} + '개'">0개</h4>
                    </div>
                </div>
                <div class="card shadow-sm mb-2 col">
                    <div class="card-body">
                        <h6 class="text-muted">📈 달성률</h6>
                        <h4 th:text="${achievementRate} + '%'">0%</h4>
                    </div>
                </div>
                <div class="card shadow-sm col">
                    <div class="card-body">
                        <h6 class="text-muted">📉 남은 수량</h6>
                        <h4 th:text="${targetQuantity - okCount} + '개'">0개</h4>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="my-4">
        <h2 class="mb-4">금형 온도 실시간 모니터링</h2>
        <div class="container pe-0 ps-0">
            <div class="row justify-content-between gx-4 gy-4">
                <div class="col-12 col-lg-4 ">
                    <h5> 금형 온도 A</h5>
                    <div class="chart-wrapper">
                        <canvas id="chartA"></canvas>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <h5> 금형 온도 B</h5>
                    <div class="chart-wrapper">
                        <canvas id="chartB"></canvas>
                    </div>
                </div>
                <div class="col-12 col-lg-4 ">
                    <h5> 금형 온도 C</h5>
                    <div class="chart-wrapper">
                        <canvas id="chartC"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="~{fragments/gauge :: gauge}" class="my-4"></div>
    <div class="col-lg-12 my-lg-2">
        <h2 class="my-4">생산량 통계</h2>
        <canvas id="monitoringChart2" class="mt-3" height="215"></canvas>
    </div>

    <h2 class="my-4">재고 건수</h2>
    <canvas id="materialChart" height="100"></canvas>
    <button id="showToastBtn" class="btn btn-refoam position-fixed bottom-0 end-0 m-4" style="z-index: 1100;">
        📋 리포트 보기
    </button>
    <div class="position-fixed bottom-0 mb-5 end-0 p-3" style="z-index: 1100">
        <div id="aiReportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">📋 AI 리포트</strong>
                <small class="text-muted">방금 전</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <span style="white-space: pre-line; margin-bottom: 0;" id="toastBody">AI 분석 리포트 불러오는 중...</span>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <!-- date-fns 어댑터 (Chart.js v3+) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>
    <style>
        canvas {
            background: #fafafa;
            border: 1px solid #ddd;
        }
    </style>
    <!-- 2) DevExtreme CSS/JS (게이지 차트용) -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">


    <script th:inline="javascript">

    <!-- 3) Chart.js (막대그래프 등 다른 차트용) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- 4) Socket.IO 클라이언트 (버전 중복 없이 하나만) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>

    <!-- 5) 사용자 커스텀 스크립트 -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            // ------------------------------
            // 1) Socket.IO 연결 (Flask-SocketIO 서버 주소)
            // ------------------------------
            const socket = io("http://localhost:5000");

            // ------------------------------
            // 2) DevExtreme CircularGauge 초기화
            // ------------------------------
            const gaugeA = $("#chartA")
                .dxCircularGauge({
                    title: { text: "금형 A 온도(℃)" },
                    rangeContainer: {
                        backgroundColor: "#E8E8E8",
                        ranges: [
                            { startValue: 0, endValue: 60, color: "#A9CCE3" },
                            { startValue: 60, endValue: 80, color: "#F7DC6F" },
                            { startValue: 80, endValue: 120, color: "#EC7063" },
                        ],
                    },
                    scale: {
                        startValue: 0,
                        endValue: 120,
                        majorTick: { color: "#000", visible: true, length: 10 },
                        minorTick: { color: "#000", visible: true, length: 5 },
                    },
                    value: 0,
                })
                .dxCircularGauge("instance");

            const gaugeB = $("#chartB")
                .dxCircularGauge({
                    title: { text: "금형 B 온도(℃)" },
                    rangeContainer: {
                        backgroundColor: "#E8E8E8",
                        ranges: [
                            { startValue: 0, endValue: 60, color: "#A9CCE3" },
                            { startValue: 60, endValue: 80, color: "#F7DC6F" },
                            { startValue: 80, endValue: 120, color: "#EC7063" },
                        ],
                    },
                    scale: {
                        startValue: 0,
                        endValue: 120,
                        majorTick: { color: "#000", visible: true, length: 10 },
                        minorTick: { color: "#000", visible: true, length: 5 },
                    },
                    value: 0,
                })
                .dxCircularGauge("instance");

            const gaugeC = $("#chartC")
                .dxCircularGauge({
                    title: { text: "금형 C 온도(℃)" },
                    rangeContainer: {
                        backgroundColor: "#E8E8E8",
                        ranges: [
                            { startValue: 0, endValue: 60, color: "#A9CCE3" },
                            { startValue: 60, endValue: 80, color: "#F7DC6F" },
                            { startValue: 80, endValue: 120, color: "#EC7063" },
                        ],
                    },
                    scale: {
                        startValue: 0,
                        endValue: 120,
                        majorTick: { color: "#000", visible: true, length: 10 },
                        minorTick: { color: "#000", visible: true, length: 5 },
                    },
                    value: 0,
                })
                .dxCircularGauge("instance");

            // ------------------------------
            // 3) Socket.IO로부터 'new_data' 이벤트 수신 → 게이지 업데이트
            // ------------------------------
            socket.on("new_data", function (data) {
                // data.values는 [tempA, tempB, tempC]
                const [tempA, tempB, tempC] = data.values;
                gaugeA.option("value", tempA);
                gaugeB.option("value", tempB);
                gaugeC.option("value", tempC);
            });

            // ------------------------------
            // 4) 막대그래프(Chart.js) 초기화 예시
            //    (이전 코드에서 이미 작성된 부분)
            // ------------------------------
            const materialLabels = /*[[${materialLabels}]]*/ [];
            const materialData = /*[[${materialData}]]*/ [];
            const materialColors = /*[[${materialColors}]]*/ [];
            const stats = /*[[${productionMonitorings}]]*/ [];
            const rate = /*[[${achievementRate}]]*/ 75;
            const target = /*[[${targetRate}]]*/ 90;
            const isAchieved = rate >= target;
            const barColor = isAchieved ? "rgba(0, 200, 100, 0.7)" : "rgba(63, 0, 255, 0.7)";
            const labels = stats.map((s) => s.date);
            const ok = stats.map((s) => s.okCount);
            const err = stats.map((s) => s.errCount);
            const order = stats.map((s) => s.orderCount);

            // materialChart (원재료별 수량)
            const ctx2 = document.getElementById("materialChart").getContext("2d");
            new Chart(ctx2, {
                type: "bar",
                data: {
                    labels: materialLabels,
                    datasets: [
                        {
                            label: "원재료별 수량",
                            data: materialData,
                            backgroundColor: materialColors,
                            borderColor: [
                                "rgba(255, 99, 132, 1)",
                                "rgba(54, 162, 235, 1)",
                                "rgba(255, 206, 86, 1)",
                                "rgba(75, 192, 192, 1)",
                                "rgba(153, 102, 255, 1)",
                                "rgba(255, 159, 64, 1)",
                            ],
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true },
                        x: { title: { display: true, text: "원재료" } },
                    },
                },
            });

            // monitoringChart2 (생산량 통계)
            new Chart(document.getElementById("monitoringChart2"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "총 주문 건수",
                            data: order,
                            backgroundColor: "rgba(0, 255, 0, 0.5)",
                        },
                        {
                            label: "완제품 수",
                            data: ok,
                            backgroundColor: "rgba(255, 0, 0, 0.5)",
                        },
                        {
                            label: "불량품 수",
                            data: err,
                            backgroundColor: "rgba(0, 0, 255, 0.5)",
                        },
                    ],
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: "생산량 통계",
                        },
                        legend: {
                            position: "top",
                        },
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "공정 날짜",
                            },
                            ticks: {
                                autoSkip: true,
                                maxRotation: 45,
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "수량",
                            },
                        },
                    },
                },
            });

            // achievementRate (오늘의 달성률)
            new Chart(document.getElementById("achievementRate"), {
                type: "bar",
                data: {
                    labels: ["목표 달성률"],
                    datasets: [
                        {
                            label: "오늘의 달성률",
                            data: [rate],
                            backgroundColor: barColor,
                            borderWidth: 0,
                        },
                    ],
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: "y",
                    scales: {
                        x: {
                            max: 100,
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + "%";
                                },
                            },
                            title: {
                                display: true,
                                text: "(목표: " + target + "%)",
                            },
                        },
                        y: {
                            grid: { display: false },
                            ticks: { display: false },
                        },
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: "top",
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return "현재 달성률 :" + context.raw + "%";
                                },
                            },
                        },
                        datalabels: {
                            display: true,
                            align: "right",
                            anchor: "end",
                            formatter: function (value) {
                                return value + "%";
                            },
                            color: "#000",
                            font: { weight: "bold" },
                        },
                    },
                },
                plugins: [ChartDataLabels],
            });

            // ------------------------------
            // 5) AI 리포트용 Toast 버튼 이벤트
            // ------------------------------
            const btn = document.getElementById("showToastBtn");
            const toastEl = document.getElementById("aiReportToast");
            const toastBody = document.getElementById("toastBody");
            const toast = new bootstrap.Toast(toastEl, { delay: 10000 });

            btn.addEventListener("click", function () {
                toastBody.textContent = "AI 리포트를 불러오는 중입니다...";
                toast.show();

                fetch("/ai-summary")
                    .then((res) => res.text())
                    .then((text) => {
                        toastBody.textContent = text;
                        toast.show();
                    })
                    .catch((err) => {
                        toastBody.textContent = "❌ 리포트 요청 실패";
                        toast.show();
                    });
            });
        });
    </script>
</div>
</html>