<html layout:decorate="~{layout}" lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container mb-5" layout:fragment="content">
    <h2 class="my-4">ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥ </h2>
    <div class="row mb-5">
        <div class="col-12 col-md-6 col-lg-6">
            <h5 class="text-center mt-3">
                ì˜¤ëŠ˜ì˜ ëª©í‘œ ìˆ˜ëŸ‰: <span th:text="${targetQuantity}">0</span>ê°œ
            </h5>
            <div class="tassei">
                <canvas id="achievementRate"></canvas>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg-6 ">
            <div class="mt-3"> </div>
            <div class="row g-3 h-100">
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <h6 class="text-muted mb-2">âœ… ë‹¬ì„± ìˆ˜ëŸ‰</h6>
                            <h4 class="mb-0" th:text="${okCount} + 'ê°œ'">0ê°œ</h4>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <h6 class="text-muted mb-2">ğŸ“ˆ ë‹¬ì„±ë¥ </h6>
                            <h4 class="mb-0" th:text="${achievementRate} + '%'">0%</h4>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center text-center">
                            <h6 class="text-muted mb-2">ğŸ“‰ ë‚¨ì€ ìˆ˜ëŸ‰</h6>
                            <h4 class="mb-0" th:text="${targetQuantity - okCount} + 'ê°œ'">0ê°œ</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ê¸ˆí˜•ì˜¨ë„ -->
    <div class="my-4">
        <h2 class="mb-4">ê¸ˆí˜• ì˜¨ë„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h2>
        <div class="container pe-0 ps-0">
            <div class="row justify-content-between gx-4 gy-4">
                <div class="col-12 col-lg-4">
                    <h5> NORMAL</h5>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartA"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <h5> BUMP</h5>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartB"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <h5>HALF</h5>
                    <div class="d-flex flex-column align-items-center">
                        <div class="gauge mb-3"></div>
                        <div class="chart-wrapper w-100">
                            <canvas id="chartC"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12 my-lg-2">
        <h2 class="my-4">ìƒì‚°ëŸ‰ í†µê³„</h2>
        <canvas id="monitoringChart2" class="mt-3" height="215"></canvas>
    </div>

    <h2 class="mb-4">ì œí’ˆë³„ ìƒì‚° í˜„í™©</h2>
    <div class="row">
        <div class="col-12 col-lg-4">
            <canvas class="my-2" id="chart-NORMAL" width="200" height="200"></canvas>
        </div>
        <div class="col-12 col-lg-4">
            <canvas class="my-2" id="chart-BUMP" width="200" height="200"></canvas>
        </div>
        <div class="col-12 col-lg-4">
            <canvas class="my-2" id="chart-HALF" width="200" height="200"></canvas>
        </div>
    </div>

    <h2 class="my-4">ì¬ê³  ê±´ìˆ˜</h2>
    <canvas id="materialChart" height="100"></canvas>
    <button id="showToastBtn" class="btn btn-refoam position-fixed bottom-0 end-0 m-4" style="z-index: 1100;">
        ğŸ“‹ ë¦¬í¬íŠ¸ ë³´ê¸°
    </button>
    <div class="position-fixed bottom-0 mb-5 end-0 p-3" style="z-index: 1100">
        <div id="aiReportToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">ğŸ“‹ AI ë¦¬í¬íŠ¸</strong>
                <small class="text-muted">ë°©ê¸ˆ ì „</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <span style="white-space: pre-line; margin-bottom: 0;" id="toastBody">AI ë¶„ì„ ë¦¬í¬íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    </div>
    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ìˆœì„œ ì¤‘ìš” -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // jQuery ì¤‘ë³µ ë¡œë”© ì²´í¬
        if (typeof jQuery === 'undefined') {
            document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
        }
    </script>

    <!-- 2. Chart.js ê´€ë ¨ (ë ˆì´ì•„ì›ƒì—ì„œ ë¡œë”©ë˜ë¯€ë¡œ ì¡°ê±´ë¶€ ë¡œë”©) -->
    <script>
        // Chart.js ì¤‘ë³µ ë¡œë”© ì²´í¬
        if (typeof Chart === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>');
        }
    </script>

    <!-- 3. Chart.js í”ŒëŸ¬ê·¸ì¸ë“¤ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- 4. DevExtreme ê³„ê¸°íŒ -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>

    <!-- 5. WebSocket ê´€ë ¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- 6. ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
        // Chart.js CDN ëŒ€ì²´ ë¡œë”© ë¡œì§
        (function() {
            const cdnList = [
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js'
            ];

            let loaded = false;
            let currentIndex = 0;

            function loadNextCDN() {
                if (loaded || currentIndex >= cdnList.length) return;

                const script = document.createElement('script');
                script.src = cdnList[currentIndex];
                script.onload = function() {
                    loaded = true;
                    console.log('Chart.js ë¡œë“œ ì„±ê³µ:', cdnList[currentIndex]);
                };
                script.onerror = function() {
                    console.log('Chart.js ë¡œë“œ ì‹¤íŒ¨:', cdnList[currentIndex]);
                    currentIndex++;
                    loadNextCDN();
                };
                document.head.appendChild(script);
            }

            loadNextCDN();
        })();
    </script>

    <!-- 3. DevExtreme (ê²Œì´ì§€ìš©) -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/22.2.6/css/dx.light.css">
    <script src="https://cdn3.devexpress.com/jslib/22.2.6/js/dx.all.js"></script>

    <!-- 4. WebSocket ê´€ë ¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- 5. ìˆ˜ì •ëœ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
        // ì „ì—­ ë³€ìˆ˜
        let temperatureCharts = [];
        let gaugeInstances = [];
        let stompClient = null;
        let isConnected = false;

        // ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° í•¨ìˆ˜
        function waitForLibraries() {
            return new Promise((resolve) => {
                const checkLibraries = () => {
                    const jqueryReady = typeof $ !== 'undefined';
                    const chartReady = typeof Chart !== 'undefined';
                    const devExtremeReady = typeof DevExpress !== 'undefined';
                    const sockjsReady = typeof SockJS !== 'undefined';
                    const stompReady = typeof Stomp !== 'undefined';

                    if (jqueryReady && chartReady && devExtremeReady && sockjsReady && stompReady) {
                        resolve();
                    } else {
                        console.log('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ëŒ€ê¸° ì¤‘...', {
                            jquery: jqueryReady,
                            chart: chartReady,
                            devExtreme: devExtremeReady,
                            sockjs: sockjsReady,
                            stomp: stompReady
                        });
                        setTimeout(checkLibraries, 500);
                    }
                };
                checkLibraries();
            });
        }

        // DOM ì¤€ë¹„ í›„ ì‹¤í–‰
        $(document).ready(function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');

            waitForLibraries().then(() => {
                console.log('ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                initializeAll();
            }).catch(error => {
                console.error('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨:', error);
            });
        });

        function initializeAll() {
            try {
                initializeBasicCharts();
                initializeTemperatureCharts();
                initializeGauges();
                initializeWebSocketConnection();
                initializeToast();
                initializeProductChart();
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ê¸°ë³¸ ì°¨íŠ¸ë“¤ (ì¬ê³ , ìƒì‚°ëŸ‰, ë‹¬ì„±ë¥ )
        function initializeBasicCharts() {
            console.log('ê¸°ë³¸ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

            // ì„œë²„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const materialLabels = /*[[${materialLabels}]]*/ [];
            const materialData = /*[[${materialData}]]*/ [];
            const materialColors = /*[[${materialColors}]]*/ [];
            const stats = /*[[${productionMonitorings}]]*/ [];
            const rate = /*[[${achievementRate}]]*/ 75;
            const target = /*[[${targetRate}]]*/ 90;
            const isAchieved = rate >= target;
            const barColor = isAchieved ? "rgba(0, 200, 100, 0.7)" : "rgba(63, 0, 255, 0.7)";

            // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
            const labels = stats.map((s) => s.date);
            const ok = stats.map((s) => s.okCount);
            const err = stats.map((s) => s.errCount);
            const order = stats.map((s) => s.orderCount);

            // ì¬ê³  ì°¨íŠ¸
            const ctx2 = document.getElementById("materialChart");
            if (ctx2) {
                new Chart(ctx2.getContext("2d"), {
                    type: "bar",
                    data: {
                        labels: materialLabels,
                        datasets: [{
                            label: "ì›ì¬ë£Œë³„ ìˆ˜ëŸ‰",
                            data: materialData,
                            backgroundColor: materialColors,
                            borderColor: [
                                'rgb(113,237,237)',
                                'rgb(147,147,147)',
                                'rgb(28,28,28)',
                                'rgb(32,121,255)',
                                'rgb(255,70,136)',
                                'rgb(113,237,237)'
                            ],
                            borderWidth: 2,
                        }],
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true },
                            x: { title: { display: true, text: "ì›ì¬ë£Œ" } },
                        },
                    },
                });
            }

            // ìƒì‚°ëŸ‰ í†µê³„ ì°¨íŠ¸
            const monitoringCtx = document.getElementById("monitoringChart2");
            if (monitoringCtx) {
                new Chart(monitoringCtx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            // ì—¬ê¸°ë¶€í„°ëŠ” ë¼ì¸ ì°¨íŠ¸ (ëœë¤ê°’ìœ¼ë¡œ ê·¸ë ¤ë†“ìŒ => í•„ìš”í•˜ë©´ ì¶”ê°€)
                            {
                                label: 'NORMAL',
                                data: [19, 17, 18, 16, 17, 12],
                                type: 'line',
                                borderColor: 'rgb(154,103,255)',
                                backgroundColor: 'rgb(156,156,255)',
                                yAxisID: 'y',
                            },
                            {
                                label: 'BUMP',
                                data: [18, 15, 17, 16, 15, 18],
                                type: 'line',
                                borderColor: 'rgb(147,147,147)',
                                backgroundColor: 'rgb(173,177,190)',
                                yAxisID: 'y',

                            },
                            {
                                label: 'HALF',
                                data: [14, 13, 16, 15, 16, 14],
                                type: 'line',
                                borderColor: 'rgb(255,99,132)',
                                backgroundColor: 'rgb(255,171,189)',
                                yAxisID: 'y',

                            },//ì—¬ê¸°ê¹Œì§€
                            {
                                label: "ì´ ì£¼ë¬¸ ê±´ìˆ˜",
                                data: order,
                                borderColor: '#0051b6',
                                backgroundColor: "#a7cffd",
                            },
                            {
                                label: "ì™„ì œí’ˆ ìˆ˜",
                                data: ok,
                                borderColor: '#369189',
                                backgroundColor: "#8ef6da",
                            },
                            {
                                label: "ë¶ˆëŸ‰í’ˆ ìˆ˜",
                                data: err,
                                borderColor: '#ff5c6c',
                                backgroundColor: "#ffbab7",
                            },
                        ],
                    },
                    options: {
                        elements: {
                            bar: {
                                borderWidth: 2,
                            }
                        },
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: "ìƒì‚°ëŸ‰ í†µê³„",
                            },
                            legend: {
                                position: "top",
                            },
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "ê³µì • ë‚ ì§œ",
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxRotation: 45,
                                },
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "ìˆ˜ëŸ‰",
                                },
                            },
                        },
                    },
                });
            }

            // ë‹¬ì„±ë¥  ì°¨íŠ¸ (ChartDataLabels í”ŒëŸ¬ê·¸ì¸ ì—†ì´)
            const achievementCtx = document.getElementById("achievementRate");
            if (achievementCtx) {
                new Chart(achievementCtx, {
                    type: "bar",
                    data: {
                        labels: ["ëª©í‘œ ë‹¬ì„±ë¥ "],
                        datasets: [{
                            label: "ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥ ",
                            data: [rate],
                            backgroundColor: barColor,
                            borderWidth: 0,
                        }],
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: "y",
                        scales: {
                            x: {
                                max: 100,
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return value + "%";
                                    },
                                },
                                title: {
                                    display: true,
                                    text: "(ëª©í‘œ: " + target + "%)",
                                },
                            },
                            y: {
                                grid: { display: false },
                                ticks: { display: false },
                            },
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: "top",
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return "í˜„ì¬ ë‹¬ì„±ë¥ : " + context.raw + "%";
                                    },
                                },
                            },
                        },
                    },
                });
            }
            console.log('ê¸°ë³¸ ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ì˜¨ë„ ë¼ì¸ ì°¨íŠ¸ ì´ˆê¸°í™” (WebSocket ë°ì´í„°ë§Œ ë°›ìŒ)
        function initializeTemperatureCharts() {
            console.log('ì˜¨ë„ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

            // double MIN_MOLD_TEMPERATURE = 80.462;
            // double MAX_MOLD_TEMPERATURE = 81.883;

            const HIGH_THRESHOLD = 81.4;
            const LOW_THRESHOLD = 80.8;
            const MAX_POINTS = 50;
            const names = ['NORMAL', 'BUMP', 'HALF'];
            const letters = ['A', 'B', 'C'];
            const colors = ['red', 'orange', 'blue'];

            temperatureCharts = letters.map((letter, i) => {
                const canvas = document.getElementById(`chart${letter}`);
                if (!canvas) {
                    console.warn(`Canvas chart${letter} not found`);
                    return null;
                }

                const ctx = canvas.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: names[i],
                            data: [],
                            borderWidth: 2,
                            fill: false,
                            borderColor: 'blue',
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            tension: 0.1,
                            pointBackgroundColor: function(context) {
                                const dataIndex = context.dataIndex;
                                const value = context.dataset.data[dataIndex];
                                if (typeof value === 'number') {
                                    if (value >= HIGH_THRESHOLD) return 'red';
                                    if (value <= LOW_THRESHOLD) return 'green';
                                }
                                return 'blue';
                            },
                            borderColor: function(context) {
                                if (context.type === 'dataset') {
                                    return 'blue';
                                }
                                const dataIndex = context.dataIndex;
                                const value = context.dataset.data[dataIndex];
                                if (typeof value === 'number') {
                                    if (value >= HIGH_THRESHOLD) return 'red';
                                    if (value <= LOW_THRESHOLD) return 'green';
                                }
                                return 'blue';
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: 'ì‹œê°„' },
                                ticks: { maxTicksLimit: 8 }
                            },
                            y: {
                                min: 80,
                                max: 82,
                                title: { display: true, text: 'ì˜¨ë„ (â„ƒ)' },
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'top' },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}â„ƒ`;
                                    }
                                }
                            }
                        }
                    }
                });
                Promise.all(
                    names.map((name, i) =>
                        fetch(`/api/temperature/${name}`)
                            .then(res => res.json())
                            .then(data => {
                                const formatted = Array.isArray(data)
                                    ? data.map(d => ({ x: new Date(d.time), y: d.value }))
                                    : [{ x: new Date(data.time), y: data.value }];
                                charts[i].data.datasets[0].data = formatted;
                                charts[i].update();
                            })
                    )
                ).then(() => {
                    // 3. WebSocket ì—°ê²°ì€ ê³¼ê±° ë°ì´í„°ê°€ ëª¨ë‘ ë¡œë”©ëœ ì´í›„ì— ì‹œì‘
                    const stompClient = Stomp.over(new SockJS('/ws'));
                    stompClient.connect({}, () => {
                        names.forEach((name, i) => {
                            stompClient.subscribe(`/topic/temperature/${name}`, message => {
                                const y = parseFloat(message.body);
                                const x = new Date();
                                const ds = charts[i].data.datasets[0];
                                ds.data.push({ x, y });
                                if (ds.data.length > MAX_POINTS) ds.data.shift();
                                charts[i].update('none');
                            });
                        });
                    });
                });

                return chart;
            }).filter(chart => chart !== null);
        }



        // ê²Œì´ì§€ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeGauges() {
            console.log('ê²Œì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

            class GaugeChart {
                constructor(el, { initialValue, higherValue, title, subtitle }) {
                    this._el = el;
                    this._initialValue = initialValue;
                    this._higherValue = higherValue;
                    this._title = title;
                    this._subtitle = subtitle;
                }

                _buildConfig() {
                    return {
                        rangeContainer: {
                            backgroundColor: '#ffffff',
                            width: 30,
                            ranges: [
                                {startValue: 78.0, endValue: 79.5, color: '#ff8228'},
                                {startValue: 79.5, endValue: 81.0, color: '#4166f5'},
                                {startValue: 81.0, endValue: 82.0, color: '#ffc228'},
                                {startValue: 82.0, endValue: 82.5, color: '#ff8228'}
                            ]
                        },
                        valueIndicator: {color: '#000'},
                        geometry: {startAngle: 200, endAngle: 340},
                        scale: {
                            startValue: 78.0,
                            endValue: this._higherValue,
                            orientation: 'outside',
                            tick: {visible: true, length: 20, width: 1, color: '#000'},
                            minorTick: {visible: true, length: 5, width: 1, color: '#000'},
                            label: {font: {color: '#4c5156', size: 12}}
                        },
                        title: {
                            verticalAlignment: 'bottom',
                            text: this._title,
                            subtitle: {
                                text: this._subtitle,
                                font: {weight: 600, size: 20}
                            }
                        },
                        value: this._initialValue
                    };
                }

                init() {
                    try {
                        this._gauge = $(this._el)
                            .dxCircularGauge(this._buildConfig())
                            .dxCircularGauge('instance');
                        console.log('ê²Œì´ì§€ ìƒì„± ì„±ê³µ:', this._subtitle);
                        return this;
                    } catch (error) {
                        console.error('ê²Œì´ì§€ ìƒì„± ì‹¤íŒ¨:', this._subtitle, error);
                        return null;
                    }
                }

                update(value) {
                    if (this._gauge) {
                        this._gauge.option('value', value);
                        this._gauge.option('title.text', `${value.toFixed(1)} ÂºC`);
                    }
                }
            }

            // ê²Œì´ì§€ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            gaugeInstances = [];
            $('.gauge').each((i, el) => {
                const letter = String.fromCharCode(65 + i); // A, B, C
                const gauge = new GaugeChart(el, {
                    initialValue: 78.0,
                    higherValue: 82.5,
                    title: '78.0 ÂºC',
                }).init();

                if (gauge) {
                    gaugeInstances.push(gauge);
                }
            });

            console.log(`ê²Œì´ì§€ ${gaugeInstances.length}ê°œ ì´ˆê¸°í™” ì™„ë£Œ`);
        }

        // WebSocket ì—°ê²° (ì‹¤ì œ ë°ì´í„°ë§Œ ë°›ìŒ)
        function initializeWebSocketConnection() {
            console.log('WebSocket ì—°ê²° ì‹œì‘');

            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                console.error('WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }

            try {
                stompClient = Stomp.over(new SockJS('/ws'));
                stompClient.connect({}, function(frame) {
                    console.log('WebSocket ì—°ê²° ì„±ê³µ:', frame);
                    isConnected = true;

                    const names = ['NORMAL', 'BUMP', 'HALF'];
                    names.forEach((name, i) => {
                        // ì˜¨ë„ ë¼ì¸ ì°¨íŠ¸ êµ¬ë…
                        stompClient.subscribe(`/topic/temperature/${name}`, function(message) {
                            const value = parseFloat(message.body);
                            const timeStr = new Date().toLocaleTimeString();

                            console.log(`ì˜¨ë„ ë°ì´í„° ìˆ˜ì‹  ${name}:`, value);

                            // ë¼ì¸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                            if (temperatureCharts[i]) {
                                const chart = temperatureCharts[i];
                                chart.data.labels.push(timeStr);
                                chart.data.datasets[0].data.push(value);

                                // ìµœëŒ€ í¬ì¸íŠ¸ ìˆ˜ ì œí•œ
                                if (chart.data.labels.length > 50) {
                                    chart.data.labels.shift();
                                    chart.data.datasets[0].data.shift();
                                }

                                chart.update('none');
                            }

                            // ê²Œì´ì§€ ì—…ë°ì´íŠ¸
                            if (gaugeInstances[i]) {
                                gaugeInstances[i].update(value);
                            }
                        });
                    });

                }, function(error) {
                    console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                    isConnected = false;
                });

            } catch (error) {
                console.error('WebSocket ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // Toast ì´ˆê¸°í™”
        function initializeToast() {
            const btn = document.getElementById("showToastBtn");
            const toastEl = document.getElementById("aiReportToast");
            const toastBody = document.getElementById("toastBody");

            if (btn && toastEl && toastBody && typeof bootstrap !== 'undefined') {
                const toast = new bootstrap.Toast(toastEl, { delay: 10000 });

                btn.addEventListener("click", function () {
                    toastBody.textContent = "AI ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
                    toast.show();

                    fetch("/ai-summary")
                        .then((res) => res.text())
                        .then((text) => {
                            toastBody.textContent = text;
                            toast.show();
                        })
                        .catch((err) => {
                            toastBody.textContent = "âŒ ë¦¬í¬íŠ¸ ìš”ì²­ ì‹¤íŒ¨";
                            toast.show();
                        });
                });
            }
        }
        // ì œí’ˆë³„ íŒŒì´ ì°¨íŠ¸ìš© ì „ì—­ ë³€ìˆ˜
        const chartMap = {};
        const productStatMap = JSON.parse(localStorage.getItem("productStatMap")) || {};
        const productNames = ['NORMAL', 'BUMP', 'HALF'];

        function initializeProductChart() {
            console.log('ì œí’ˆë³„ íŒŒì´ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');

            // ì°¨íŠ¸ ì´ˆê¸°í™”
            productNames.forEach(name => {
                const ctx = document.getElementById(`chart-${name}`);
                if (!ctx) {
                    console.warn(`chart-${name} ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }

                chartMap[name] = new Chart(ctx.getContext("2d"), {
                    type: 'pie',
                    data: {
                        labels: ['ì •ìƒ ì œí’ˆ ìˆ˜', 'ë¶ˆëŸ‰ ì œí’ˆ ìˆ˜'],
                        datasets: [{
                            data: [0, 0],
                            borderColor: ['#0051b6','rgb(255,99,132)'],
                            backgroundColor: ['#a6cdfb', '#fdb9b6'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${name} ì œí’ˆ ìƒì‚° ë¹„ìœ¨`
                            },
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.label}: ${context.parsed}ê°œ`;
                                    }
                                }
                            }
                        }
                    }
                });
            });

            // ì´ˆê¸° ë°ì´í„° ë¡œë”©
            fetch('/api/production/by-product')
                .then(res => res.json())
                .then(data => {
                    data.forEach(({ productName, okCount, errorCount, timestamp }) => {
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    });
                }).catch(err => {
                console.error("ì´ˆê¸° ì œí’ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            });

            // WebSocket ì—°ê²° ë° êµ¬ë…
            if (typeof Stomp !== 'undefined' && typeof SockJS !== 'undefined') {
                const stomp = Stomp.over(new SockJS("/ws"));
                stomp.connect({}, () => {
                    stomp.subscribe("/topic/product-count", message => {
                        const { productName, okCount, errorCount, timestamp } = JSON.parse(message.body);
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    });

                    // localStorageì— ì €ì¥ëœ ì´ì „ ê°’ ë³µì›
                    for (const [productName, { okCount, errorCount, timestamp }] of Object.entries(productStatMap)) {
                        updateProductChart(productName, okCount, errorCount, timestamp);
                    }
                });
            } else {
                console.warn("WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•„ ì œí’ˆ ì°¨íŠ¸ WebSocketì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.");
            }

            console.log('ì œí’ˆë³„ íŒŒì´ ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProductChart(productName, okCount, errorCount, timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            if (
                date.getFullYear() !== today.getFullYear() ||
                date.getMonth() !== today.getMonth() ||
                date.getDate() !== today.getDate()
            ) return;

            productStatMap[productName] = { okCount, errorCount, timestamp };
            localStorage.setItem("productStatMap", JSON.stringify(productStatMap));

            const chart = chartMap[productName];
            if (!chart) return;

            chart.data.datasets[0].data = [okCount, errorCount];
            chart.update();
        }

        // ì—°ê²° ìƒíƒœ ì²´í¬ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
        function checkConnectionStatus() {
            console.log('ì—°ê²° ìƒíƒœ:', {
                webSocketConnected: isConnected,
                temperatureChartsCount: temperatureCharts.length,
                gaugeCount: gaugeInstances.length
            });
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
        window.checkConnectionStatus = checkConnectionStatus;
    </script>
</div>
</html>